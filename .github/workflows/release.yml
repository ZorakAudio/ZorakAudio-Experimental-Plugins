name: Build & Release

env:
  FAUST_VERSION: "2.81.2"

on:
  push:
    tags:
      - "v*"
      - "R*"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
      # Quick check for required macOS tools
      - name: macOS pre-build preflight
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail

          echo "== macOS pre-build preflight =="

          need() {
            command -v "$1" >/dev/null 2>&1 || {
              echo "ERROR: required command '$1' not found"
              exit 127
            }
          }

          # Commands we rely on later
          need find
          need grep
          need sed
          need file
          need lipo
          need codesign
          need spctl
          need ditto
          need python3

          echo "All required macOS tools present"

      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            faust ninja-build build-essential pkg-config \
            libasound2-dev libjack-jackd2-dev \
            libgtk-3-dev libwebkit2gtk-4.1-dev \
            libx11-dev libxext-dev libxrandr-dev libxinerama-dev libxcursor-dev \
            libfreetype-dev libfontconfig1-dev \
            libglu1-mesa-dev mesa-common-dev

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install faust ninja

      - name: Install deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install ninja --no-progress
          $ErrorActionPreference = "Stop"

          $v = "${{ env.FAUST_VERSION }}"
          $exe = "$env:RUNNER_TEMP\faust.exe"

          Invoke-WebRequest -Uri "https://github.com/grame-cncm/faust/releases/download/$v/Faust-$v-win64.exe" -OutFile $exe
          Start-Process -FilePath $exe -ArgumentList "/S" -Wait

          # Find faust.exe
          $faust = Get-ChildItem "C:\Program Files", "C:\Program Files (x86)" -Recurse -Filter faust.exe -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $faust) { throw "faust.exe not found after install" }

          $faustDir = Split-Path $faust.FullName

          # Make it available NOW (this step) and ALSO for later steps
          $env:Path = "$faustDir;$env:Path"
          $faustDir | Out-File -FilePath $env:GITHUB_PATH -Append

          faust --version


      - name: Configure macOS universal2
        if: runner.os == 'macOS'
        run: |
          echo "CMAKE_OSX_ARCHITECTURES=arm64;x86_64" >> $GITHUB_ENV
          echo "CMAKE_OSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV
          echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV

      - name: Build + package
        run: |
          python scripts/build.py --config Release --tag "${{ github.ref_name }}" --out dist

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.os }}
          path: dist
          if-no-files-found: error

  release:
    name: Create/Update Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Publish GitHub Release + upload zips
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          if [[ "$TAG" == R* ]]; then
            gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" --generate-notes
          else
            gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" --generate-notes --prerelease
          fi


          files=(dist/**/ZorakAudio-Experimental-Plugins-${TAG}-*.zip)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No zip files found to upload"
            exit 2
          fi

          for attempt in 1 2 3; do
            echo "Upload attempt $attempt..."
            if gh release upload "$TAG" "${files[@]}" --clobber; then
              printf 'Uploading:\n%s\n' "${files[@]}"
              exit 0
            fi
            sleep 2
          done
          exit 1


