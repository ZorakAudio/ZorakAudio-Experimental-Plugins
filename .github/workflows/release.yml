name: Build & Release

env:
  FAUST_VERSION: "2.81.2"

on:
  push:
    tags:
      - "v*"
      - "R*"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
      # Quick check for required macOS tools
      - name: macOS pre-build preflight
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail

          echo "== macOS pre-build preflight =="

          need() {
            command -v "$1" >/dev/null 2>&1 || {
              echo "ERROR: required command '$1' not found"
              exit 127
            }
          }

          # Commands we rely on later
          need find
          need grep
          need sed
          need file
          need lipo
          need codesign
          need spctl
          need ditto
          need python3

          echo "All required macOS tools present"

      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            faust ninja-build build-essential pkg-config \
            libasound2-dev libjack-jackd2-dev \
            libgtk-3-dev libwebkit2gtk-4.1-dev \
            libx11-dev libxext-dev libxrandr-dev libxinerama-dev libxcursor-dev \
            libfreetype-dev libfontconfig1-dev \
            libglu1-mesa-dev mesa-common-dev

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install faust ninja

      - name: Install deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          choco install ninja --no-progress
          $ErrorActionPreference = "Stop"

          $v = "${{ env.FAUST_VERSION }}"
          $exe = "$env:RUNNER_TEMP\faust.exe"

          Invoke-WebRequest -Uri "https://github.com/grame-cncm/faust/releases/download/$v/Faust-$v-win64.exe" -OutFile $exe
          Start-Process -FilePath $exe -ArgumentList "/S" -Wait

          # Find faust.exe
          $faust = Get-ChildItem "C:\Program Files", "C:\Program Files (x86)" -Recurse -Filter faust.exe -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $faust) { throw "faust.exe not found after install" }

          $faustDir = Split-Path $faust.FullName

          # Make it available NOW (this step) and ALSO for later steps
          $env:Path = "$faustDir;$env:Path"
          $faustDir | Out-File -FilePath $env:GITHUB_PATH -Append

          faust --version


      - name: Configure macOS universal2
        if: runner.os == 'macOS'
        run: |
          echo "CMAKE_OSX_ARCHITECTURES=arm64;x86_64" >> $GITHUB_ENV
          echo "CMAKE_OSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV
          echo "MACOSX_DEPLOYMENT_TARGET=11.0" >> $GITHUB_ENV

      - name: Build + package
        run: |
          python scripts/build.py --config Release --tag "${{ github.ref_name }}" --out dist

      - name: macOS post-build - ad-hoc sign + verify + rezip with ditto (bash3-safe)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail

          echo "== Find mac artifacts =="
          VST3_COUNT=0
          CLAP_COUNT=0

          echo "VST3 bundles:"
          find dist -name "*.vst3" -maxdepth 10 -type d -print || true

          echo "CLAP binaries:"
          find dist -name "*.clap" -maxdepth 10 -type f -print || true

          echo "== Ad-hoc sign VST3 bundles =="
          while IFS= read -r b; do
            [ -n "$b" ] || continue
            VST3_COUNT=$((VST3_COUNT+1))
            echo "-- signing: $b"
            codesign --force --deep --sign - "$b" || true
          done < <(find dist -name "*.vst3" -maxdepth 10 -type d -print 2>/dev/null || true)

          echo "== Ad-hoc sign CLAP binaries =="
          while IFS= read -r c; do
            [ -n "$c" ] || continue
            CLAP_COUNT=$((CLAP_COUNT+1))
            echo "-- signing: $c"
            codesign --force --sign - "$c" || true
          done < <(find dist -name "*.clap" -maxdepth 10 -type f -print 2>/dev/null || true)

          if [ "$VST3_COUNT" -eq 0 ] && [ "$CLAP_COUNT" -eq 0 ]; then
            echo "No mac plugin artifacts found under dist/"
            exit 2
          fi

          echo "== Verify + Gatekeeper assessment (diagnostic only) =="
          while IFS= read -r b; do
            [ -n "$b" ] || continue
            echo "-- verify: $b"
            codesign --verify --deep --strict --verbose=4 "$b" || true
            spctl --assess --type execute --verbose=4 "$b" || true
          done < <(find dist -name "*.vst3" -maxdepth 10 -type d -print 2>/dev/null || true)

          echo "== Arch check =="
          while IFS= read -r b; do
            [ -n "$b" ] || continue
            BIN="$(ls -1 "$b/Contents/MacOS/"* 2>/dev/null | head -n 1 || true)"
            echo "-- VST3 bin: $BIN"
            if [ -n "${BIN:-}" ]; then
              file "$BIN" || true
              lipo -info "$BIN" || true
            fi
          done < <(find dist -name "*.vst3" -maxdepth 10 -type d -print 2>/dev/null || true)

          while IFS= read -r c; do
            [ -n "$c" ] || continue
            echo "-- CLAP: $c"
            file "$c" || true
            lipo -info "$c" || true
          done < <(find dist -name "*.clap" -maxdepth 10 -type f -print 2>/dev/null || true)

          echo "== Assert universal2 (fail if missing arch) =="
          # VST3 inner binary must contain both x86_64 and arm64
          while IFS= read -r b; do
            [ -n "$b" ] || continue
            BIN="$(ls -1 "$b/Contents/MacOS/"* 2>/dev/null | head -n 1 || true)"
            [ -n "${BIN:-}" ] || continue
            lipo -info "$BIN" | grep -q "x86_64" || { echo "Missing x86_64 in $BIN"; exit 3; }
            lipo -info "$BIN" | grep -q "arm64"  || { echo "Missing arm64 in $BIN"; exit 3; }
          done < <(find dist -name "*.vst3" -maxdepth 10 -type d -print 2>/dev/null || true)

          # CLAP must contain both x86_64 and arm64
          while IFS= read -r c; do
            [ -n "$c" ] || continue
            lipo -info "$c" | grep -q "x86_64" || { echo "Missing x86_64 in $c"; exit 4; }
            lipo -info "$c" | grep -q "arm64"  || { echo "Missing arm64 in $c"; exit 4; }
          done < <(find dist -name "*.clap" -maxdepth 10 -type f -print 2>/dev/null || true)

          echo "== Re-zip mac artifacts using ditto =="
          while IFS= read -r b; do
            [ -n "$b" ] || continue
            base="$(basename "$b")"
            dir="$(dirname "$b")"
            zip="$dir/${base%.vst3}-mac.zip"
            echo "-- ditto zip: $zip"
            rm -f "$zip"
            ditto -c -k --sequesterRsrc --keepParent "$b" "$zip"
          done < <(find dist -name "*.vst3" -maxdepth 10 -type d -print 2>/dev/null || true)

          while IFS= read -r c; do
            [ -n "$c" ] || continue
            base="$(basename "$c")"
            dir="$(dirname "$c")"
            zip="$dir/${base%.clap}-mac.zip"
            echo "-- ditto zip: $zip"
            rm -f "$zip"
            ditto -c -k --sequesterRsrc --keepParent "$c" "$zip"
          done < <(find dist -name "*.clap" -maxdepth 10 -type f -print 2>/dev/null || true)


      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.os }}
          path: dist
          if-no-files-found: error

  release:
    name: Create/Update Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Publish GitHub Release + upload zips
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          if [[ "$TAG" == R* ]]; then
            gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" --generate-notes
          else
            gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" --generate-notes --prerelease
          fi


          files=(dist/**/**/*.zip)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No zip files found to upload"
            exit 2
          fi

          gh release upload "$TAG" "${files[@]}" --clobber

