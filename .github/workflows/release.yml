name: Build & Release

on:
  push:
    tags:
      - "v*"
      - "R*"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            faust ninja-build build-essential pkg-config \
            libasound2-dev libjack-jackd2-dev \
            libgtk-3-dev libwebkit2gtk-4.1-dev \
            libx11-dev libxext-dev libxrandr-dev libxinerama-dev libxcursor-dev \
            libfreetype-dev libfontconfig1-dev \
            libglu1-mesa-dev mesa-common-dev

      - name: Install deps (macOS)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install faust ninja

      - name: Install deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
            choco install ninja --no-progress

            $ErrorActionPreference = "Stop"
            $faustVersion = "2.79.2"
            $zip = "$env:RUNNER_TEMP\faust.zip"
            $dir = "$env:RUNNER_TEMP\faust"

            Invoke-WebRequest -Uri "https://github.com/grame-cncm/faust/releases/download/$faustVersion/Faust-$faustVersion-win64.zip" -OutFile $zip
            Expand-Archive -Path $zip -DestinationPath $dir -Force

            $faust = Get-ChildItem $dir -Recurse -Filter faust.exe | Select-Object -First 1
            if (-not $faust) { throw "faust.exe not found in extracted archive" }

            (Split-Path $faust.FullName) | Out-File -FilePath $env:GITHUB_PATH -Append
            faust -version


      - name: Build + package
        env:
          GIT_TAG: ${{ github.ref_name }}
        run: |
          python scripts/build.py --config Release --tag "$GIT_TAG" --out dist

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.os }}
          path: dist
          if-no-files-found: error

  release:
    name: Create/Update Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Publish GitHub Release + upload zips
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          shopt -s globstar nullglob

          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG" --generate-notes

          files=(dist/**/**/*.zip)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No zip files found to upload"
            exit 2
          fi

          gh release upload "$TAG" "${files[@]}" --clobber
