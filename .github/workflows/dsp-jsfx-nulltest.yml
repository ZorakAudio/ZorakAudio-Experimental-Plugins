name: JSFX Null Tests

"on":
  workflow_call: {}
  workflow_dispatch: {}
  push:
    paths:
      - "**/*.jsfx"
      - "**/*.rpp"
      - "plugins.json"
      - ".ci/**"
  pull_request: {}

jobs:
  jsfx-nulltests:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: python -m pip install --upgrade pip numpy llvmlite

      - name: Install LLVM (clang)
        shell: pwsh
        run: |
          choco install llvm -y
          refreshenv
          clang --version
      - name: Cache portable REAPER
        uses: actions/cache@v4
        with:
          path: .ci/reaper-portable
          key: reaper-portable-${{ runner.os }}-v2

      - name: Restore portable REAPER (cache or unzip)
        shell: pwsh
        run: |
          $root = ".ci\reaper-portable"

          # Cache hit?
          $exe = Get-ChildItem -Path $root -Recurse -Filter reaper.exe -File -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($exe) {
            Write-Host "Found REAPER: $($exe.FullName)"
            exit 0
          }

          # Cache miss -> unzip from repo (place the zip here)
          $zip = ".ci\Reaper (Portable).zip"
          if (!(Test-Path $zip)) {
            throw "No cached REAPER and missing $zip. Add the zip to repo (or download it here) to bootstrap."
          }

          Write-Host "Cache miss: extracting $zip -> $root"
          New-Item -ItemType Directory -Force -Path $root | Out-Null
          Expand-Archive -Path $zip -DestinationPath $root -Force

          $exe = Get-ChildItem -Path $root -Recurse -Filter reaper.exe -File | Select-Object -First 1
          if (-not $exe) { throw "Extraction completed but reaper.exe still not found under $root" }

          Write-Host "Extracted REAPER: $($exe.FullName)"

      - name: Run JSFX null tests
        shell: pwsh
        env:
          NULLTEST_TOL: "1e-6"
          NULLTEST_TIMEOUT_S: "900"
          NULLTEST_REPORT_DIR: ${{ github.workspace }}\.ci\out
        run: |
          $exe = Get-ChildItem -Path ".ci\reaper-portable" -Recurse -Filter reaper.exe -File | Select-Object -First 1
          if (-not $exe) { throw "reaper.exe not found after restore step" }

          $env:REAPER_PORTABLE_DIR = Split-Path $exe.FullName -Parent
          Write-Host "REAPER_PORTABLE_DIR=$env:REAPER_PORTABLE_DIR"

          python scripts\run_dsp-jsfx_nulltests.py
      - name: Debug REAPER hang (screenshot + window titles + kill)
        if: failure()
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path .ci\out | Out-Null

          # Window titles
          Add-Type @"
          using System;
          using System.Runtime.InteropServices;
          using System.Text;
          public class WinEnum {
            public delegate bool EnumWindowsProc(IntPtr hWnd, IntPtr lParam);
            [DllImport("user32.dll")] public static extern bool EnumWindows(EnumWindowsProc lpEnumFunc, IntPtr lParam);
            [DllImport("user32.dll")] public static extern int GetWindowText(IntPtr hWnd, StringBuilder lpString, int nMaxCount);
            [DllImport("user32.dll")] public static extern bool IsWindowVisible(IntPtr hWnd);
          }
          "@
              $titles = New-Object System.Collections.Generic.List[string]
              [WinEnum]::EnumWindows({ param($h,$l)
                if([WinEnum]::IsWindowVisible($h)){
                  $sb = New-Object System.Text.StringBuilder 512
                  [void][WinEnum]::GetWindowText($h, $sb, $sb.Capacity)
                  $t = $sb.ToString()
                  if($t.Length -gt 0){ $titles.Add($t) }
                }
                return $true
              }, [IntPtr]::Zero)
              $titles | Sort-Object | Set-Content .ci\out\window_titles.txt

              # Screenshot desktop
              Add-Type -AssemblyName System.Windows.Forms
              Add-Type -AssemblyName System.Drawing
              $b = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
              $bmp = New-Object System.Drawing.Bitmap $b.Width, $b.Height
              $g = [System.Drawing.Graphics]::FromImage($bmp)
              $g.CopyFromScreen($b.Location, [System.Drawing.Point]::Empty, $b.Size)
              $bmp.Save(".ci\out\screenshot.png", [System.Drawing.Imaging.ImageFormat]::Png)
              $g.Dispose(); $bmp.Dispose()

              # Kill REAPER so the job doesn't linger
              Get-Process reaper -ErrorAction SilentlyContinue | Stop-Process -Force


      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jsfx-nulltest-report
          path: .ci/out
